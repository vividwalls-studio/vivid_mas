name: Deploy to DigitalOcean

on:
  push:
    branches: [ vivid-main ]
  pull_request:
    branches: [ vivid-main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.DIGITALOCEAN_SSH_KEY }}
        
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.DIGITALOCEAN_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to DigitalOcean
      env:
        DIGITALOCEAN_HOST: ${{ secrets.DIGITALOCEAN_HOST }}
        DIGITALOCEAN_USER: ${{ secrets.DIGITALOCEAN_USER }}
      run: |
        echo "üöÄ Starting deployment to DigitalOcean..."
        
        # Create deployment directory on server
        ssh $DIGITALOCEAN_USER@$DIGITALOCEAN_HOST "mkdir -p /tmp/vivid_mas_deploy"
        
        # Copy files to server (excluding .git and node_modules)
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.env' \
          ./ $DIGITALOCEAN_USER@$DIGITALOCEAN_HOST:/tmp/vivid_mas_deploy/
        
        # Execute deployment script on server
        ssh $DIGITALOCEAN_USER@$DIGITALOCEAN_HOST << 'EOF'
          set -e
          echo "üì¶ Updating VividMAS platform..."
          
          # Backup current deployment
          sudo cp -r /home/vivid/vivid_mas /home/vivid/vivid_mas_backup_$(date +%Y%m%d_%H%M%S) || true
          
          # Copy new files (preserve existing .env) but include env.optimized
          sudo rsync -av --exclude='.env' /tmp/vivid_mas_deploy/ /home/vivid/vivid_mas/
          
          # If an optimized environment file is present, use it when no .env exists
          if [ ! -f /home/vivid/vivid_mas/.env ] && [ -f /home/vivid/vivid_mas/env.optimized ]; then
            echo "üîÑ No .env found ‚Äì using env.optimized as .env"
            sudo cp /home/vivid/vivid_mas/env.optimized /home/vivid/vivid_mas/.env
          fi
          
          # Set proper ownership
          sudo chown -R vivid:vivid /home/vivid/vivid_mas
          
          # Navigate to project directory
          cd /home/vivid/vivid_mas
          
          # ------------------------------------------------------------
          # üê≥ 1. Stop & remove any legacy containers / networks
          # ------------------------------------------------------------
          echo "üßπ Removing legacy containers (if any) ..."
          sudo docker compose -f docker-compose.yml down --remove-orphans || true
          sudo docker compose -f wordpress-compose.yml down --remove-orphans || true
          
          # ------------------------------------------------------------
          # üê≥ 2. Pull latest images for the _optimized_ stack
          # ------------------------------------------------------------
          echo "üì• Pulling images for optimized stack ..."
          sudo docker compose -f docker-compose.optimized.yml pull
          sudo docker compose -f wordpress-compose.optimized.yml pull || true
          
          # ------------------------------------------------------------
          # üê≥ 3. Start core platform services
          # ------------------------------------------------------------
          sudo docker compose -f docker-compose.optimized.yml up -d --remove-orphans
          
          # ------------------------------------------------------------
          # üê≥ 4. Start WordPress (optional) services
          # ------------------------------------------------------------
          if [ -f "../wordpress-compose.optimized.yml" ] || [ -f "wordpress-compose.optimized.yml" ]; then
            sudo docker compose -f wordpress-compose.optimized.yml up -d --remove-orphans
          fi
          
          # ------------------------------------------------------------
          # üßΩ 5. Prune dangling images to save disk space
          # ------------------------------------------------------------
          sudo docker image prune -af || true
          
          # Clean up temporary files
          rm -rf /tmp/vivid_mas_deploy
          
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Services available at:"
          echo "  - n8n: https://n8n.vividwalls.blog"
          echo "  - WebUI: https://webui.vividwalls.blog"
          echo "  - WordPress: https://vividwalls.blog"
          
          # Show running containers
          sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        EOF
        
        echo "üéâ Deployment to DigitalOcean completed!"
        
    - name: Verify Deployment
      env:
        DIGITALOCEAN_HOST: ${{ secrets.DIGITALOCEAN_HOST }}
        DIGITALOCEAN_USER: ${{ secrets.DIGITALOCEAN_USER }}
      run: |
        echo "üîç Verifying deployment..."
        
        # Check if services are responding
        sleep 30  # Wait for services to start
        
        # Test n8n endpoint
        if curl -f -s https://n8n.vividwalls.blog > /dev/null; then
          echo "‚úÖ n8n is responding"
        else
          echo "‚ùå n8n is not responding"
          exit 1
        fi
        
        # Test WordPress endpoint  
        if curl -f -s https://vividwalls.blog > /dev/null; then
          echo "‚úÖ WordPress is responding"
        else
          echo "‚ùå WordPress is not responding"
          exit 1
        fi
        
        echo "üéØ All services verified successfully!" 