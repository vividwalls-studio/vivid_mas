version: '3.8'

# CRITICAL: All services must use the vivid_mas network
networks:
  default:
    name: vivid_mas
    external: true

services:
  # =============================================================================
  # LISTMONK - Email Marketing Platform
  # =============================================================================
  
  # ListMonk application
  listmonk:
    image: listmonk/listmonk:latest
    container_name: listmonk
    restart: unless-stopped
    ports:
      - "9003:9000"
    environment:
      - LISTMONK_app__address=0.0.0.0:9000
      - LISTMONK_app__admin_username=${LISTMONK_ADMIN_USERNAME:-admin}
      - LISTMONK_app__admin_password=${LISTMONK_ADMIN_PASSWORD:-admin}
      - LISTMONK_db__host=postgres
      - LISTMONK_db__port=5432
      - LISTMONK_db__user=listmonk_user
      - LISTMONK_db__password=listmonk_secure_password_2024
      - LISTMONK_db__database=listmonk
      - LISTMONK_db__ssl_mode=disable
      - LISTMONK_db__max_open=25
      - LISTMONK_db__max_idle=25
      - LISTMONK_db__max_lifetime=300s
    command: sh -c "./listmonk --install --yes && ./listmonk"
    external_links:
      - postgres
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Note: ListMonk now uses consolidated PostgreSQL instance

# =============================================================================
# VOLUMES
# =============================================================================
# Note: No local volumes needed - using consolidated PostgreSQL

# =============================================================================
# NOTES
# =============================================================================
# 1. This service requires the vivid_mas network to be created first
# 2. ListMonk uses its own PostgreSQL database instance (isolated from main postgres)
# 3. Accessible via https://listmonk.vividwalls.blog through Caddy reverse proxy
# 4. Default admin credentials: admin/admin (configure via environment variables)
# 5. Exposed on port 9003 externally