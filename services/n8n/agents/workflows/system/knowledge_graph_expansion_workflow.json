{
  "name": "Agent Knowledge Graph Expansion",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 24
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Daily Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://localhost:11235/health",
        "options": {}
      },
      "id": "check-crawl4ai",
      "name": "Check Crawl4AI Health",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "functionCode": "// Get list of agents to update\nconst agents = [\n  'marketing_director',\n  'analytics_director',\n  'social_media_director',\n  'creative_content',\n  'audience_intelligence',\n  'product_performance',\n  'customer_sentiment'\n];\n\n// Return array of items for each agent\nreturn agents.map(agent => ({\n  json: {\n    agent_key: agent,\n    timestamp: new Date().toISOString()\n  }\n}));"
      },
      "id": "prepare-agents",
      "name": "Prepare Agent List",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "split-batches",
      "name": "Split Into Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.VIVIDWALLS_API_URL }}/api/ontology/expand",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "agent_key",
              "value": "={{ $json.agent_key }}"
            },
            {
              "name": "expansion_type",
              "value": "trending_topics"
            },
            {
              "name": "max_items",
              "value": "10"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "expand-ontology",
      "name": "Expand Agent Ontology",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "functionCode": "// Extract trending topics from various sources\nconst agent = $input.item.json.agent_key;\nconst sources = {\n  marketing_director: [\n    'https://trends.google.com/trends/api/dailytrends?geo=US&cat=business',\n    'https://api.reddit.com/r/marketing/hot.json'\n  ],\n  analytics_director: [\n    'https://api.reddit.com/r/datascience/hot.json',\n    'https://api.reddit.com/r/businessintelligence/hot.json'\n  ],\n  social_media_director: [\n    'https://api.reddit.com/r/socialmedia/hot.json',\n    'https://trends.google.com/trends/api/dailytrends?geo=US&cat=entertainment'\n  ],\n  creative_content: [\n    'https://api.reddit.com/r/copywriting/hot.json',\n    'https://api.reddit.com/r/content_marketing/hot.json'\n  ],\n  audience_intelligence: [\n    'https://api.reddit.com/r/marketing/hot.json',\n    'https://api.reddit.com/r/CustomerSuccess/hot.json'\n  ],\n  product_performance: [\n    'https://api.reddit.com/r/ecommerce/hot.json',\n    'https://api.reddit.com/r/ProductManagement/hot.json'\n  ],\n  customer_sentiment: [\n    'https://api.reddit.com/r/CustomerService/hot.json',\n    'https://api.reddit.com/r/CustomerExperience/hot.json'\n  ]\n};\n\nreturn {\n  json: {\n    agent_key: agent,\n    trending_sources: sources[agent] || [],\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "get-trending",
      "name": "Get Trending Topics",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "neo4j",
        "query": "MATCH (ns:Namespace {name: $namespace})\nSET ns.last_expanded = datetime(),\n    ns.expansion_count = coalesce(ns.expansion_count, 0) + 1\nRETURN ns.name as namespace, ns.expansion_count as total_expansions",
        "parameters": {
          "namespace": "={{ $json.agent_key }}"
        }
      },
      "id": "update-neo4j",
      "name": "Update Neo4j Timestamp",
      "type": "n8n-nodes-community.neo4j",
      "typeVersion": 1,
      "position": [1450, 300],
      "credentials": {
        "neo4j": {
          "id": "1",
          "name": "Neo4j VividWalls"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Compile expansion results\nconst results = $items.map(item => ({\n  agent: item.json.agent_key,\n  status: item.json.success ? 'success' : 'failed',\n  concepts_added: item.json.concepts_added || 0,\n  sources_crawled: item.json.sources_crawled || 0,\n  timestamp: item.json.timestamp\n}));\n\nconst summary = {\n  total_agents: results.length,\n  successful: results.filter(r => r.status === 'success').length,\n  failed: results.filter(r => r.status === 'failed').length,\n  total_concepts: results.reduce((sum, r) => sum + r.concepts_added, 0),\n  total_sources: results.reduce((sum, r) => sum + r.sources_crawled, 0),\n  timestamp: new Date().toISOString(),\n  details: results\n};\n\nreturn [{ json: summary }];"
      },
      "id": "compile-results",
      "name": "Compile Results",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "channel": "#knowledge-graph-updates",
        "text": "=**Knowledge Graph Expansion Complete**\\n\\n:white_check_mark: Agents Updated: {{ $json.successful }}/{{ $json.total_agents }}\\n:books: New Concepts: {{ $json.total_concepts }}\\n:globe_with_meridians: Sources Crawled: {{ $json.total_sources }}\\n\\nTimestamp: {{ $json.timestamp }}",
        "otherOptions": {}
      },
      "id": "notify-slack",
      "name": "Notify Slack",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [1850, 300],
      "credentials": {
        "slackApi": {
          "id": "2",
          "name": "Slack VividWalls"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.status }}",
              "value2": 200
            }
          ]
        }
      },
      "id": "if-healthy",
      "name": "If Crawl4AI Healthy",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [550, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "error",
              "value": "Crawl4AI is not available"
            }
          ]
        },
        "options": {}
      },
      "id": "set-error",
      "name": "Set Error",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [650, 450]
    },
    {
      "parameters": {
        "channel": "#alerts",
        "text": ":warning: Knowledge Graph Expansion Failed\\n\\nError: {{ $json.error }}\\nPlease check Crawl4AI container status.",
        "otherOptions": {}
      },
      "id": "notify-error",
      "name": "Notify Error",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [850, 450],
      "credentials": {
        "slackApi": {
          "id": "2",
          "name": "Slack VividWalls"
        }
      }
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      },
      "id": "wait",
      "name": "Wait 5s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [950, 300]
    }
  ],
  "connections": {
    "schedule-trigger": {
      "main": [
        [
          {
            "node": "check-crawl4ai",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-crawl4ai": {
      "main": [
        [
          {
            "node": "if-healthy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if-healthy": {
      "main": [
        [
          {
            "node": "prepare-agents",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "set-error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-agents": {
      "main": [
        [
          {
            "node": "split-batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "split-batches": {
      "main": [
        [
          {
            "node": "wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "wait": {
      "main": [
        [
          {
            "node": "expand-ontology",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "expand-ontology": {
      "main": [
        [
          {
            "node": "get-trending",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get-trending": {
      "main": [
        [
          {
            "node": "update-neo4j",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update-neo4j": {
      "main": [
        [
          {
            "node": "split-batches",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "set-error": {
      "main": [
        [
          {
            "node": "notify-error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "split-batches": {
      "main": [
        [
          {
            "node": "compile-results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "compile-results": {
      "main": [
        [
          {
            "node": "notify-slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": [
    {
      "name": "knowledge-graph",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "notes": "This workflow automatically expands agent knowledge graphs by:\n1. Crawling trending topics relevant to each agent's domain\n2. Extracting new concepts and relationships\n3. Updating the Neo4j knowledge graph\n4. Notifying the team of updates\n\nRuns daily to keep agent knowledge current."
}