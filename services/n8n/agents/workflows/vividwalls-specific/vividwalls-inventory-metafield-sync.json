{
  "name": "VividWalls - Sync Inventory to Shopify Metafields",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "Every 5 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  pe.handle,\n  pe.edition_size,\n  pe.small_allocation,\n  pe.small_sold,\n  pe.small_allocation - pe.small_sold as small_available,\n  pe.medium_allocation,\n  pe.medium_sold,\n  pe.medium_allocation - pe.medium_sold as medium_available,\n  pe.large_allocation,\n  pe.large_sold,\n  pe.large_allocation - pe.large_sold as large_available,\n  pe.total_sold,\n  string_agg(DISTINCT svm.shopify_product_id::text, ',') as shopify_product_ids\nFROM product_editions pe\nLEFT JOIN shopify_variant_mapping svm ON pe.handle = svm.handle\nWHERE pe.is_active = true\nAND svm.shopify_product_id IS NOT NULL\nGROUP BY pe.handle, pe.edition_size, pe.small_allocation, pe.small_sold, \n         pe.medium_allocation, pe.medium_sold, pe.large_allocation, pe.large_sold, pe.total_sold",
        "additionalFields": {}
      },
      "id": "postgres-get-inventory",
      "name": "Get Inventory Data",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [450, 300],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Supabase PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 5,
        "options": {}
      },
      "id": "batch-products",
      "name": "Batch Products",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "functionCode": "// Prepare metafield updates for each product\nconst items = [];\n\nfor (const item of $input.all()) {\n  const productIds = item.json.shopify_product_ids.split(',');\n  \n  // Create metafield payload for each product ID\n  for (const productId of productIds) {\n    const metafields = [\n      {\n        namespace: 'vividwalls',\n        key: 'edition_size',\n        value: item.json.edition_size.toString(),\n        type: 'number_integer'\n      },\n      {\n        namespace: 'vividwalls',\n        key: 'small_allocation',\n        value: item.json.small_allocation.toString(),\n        type: 'number_integer'\n      },\n      {\n        namespace: 'vividwalls',\n        key: 'small_available',\n        value: item.json.small_available.toString(),\n        type: 'number_integer'\n      },\n      {\n        namespace: 'vividwalls',\n        key: 'small_sold',\n        value: item.json.small_sold.toString(),\n        type: 'number_integer'\n      },\n      {\n        namespace: 'vividwalls',\n        key: 'medium_allocation',\n        value: item.json.medium_allocation.toString(),\n        type: 'number_integer'\n      },\n      {\n        namespace: 'vividwalls',\n        key: 'medium_available',\n        value: item.json.medium_available.toString(),\n        type: 'number_integer'\n      },\n      {\n        namespace: 'vividwalls',\n        key: 'medium_sold',\n        value: item.json.medium_sold.toString(),\n        type: 'number_integer'\n      },\n      {\n        namespace: 'vividwalls',\n        key: 'large_allocation',\n        value: item.json.large_allocation.toString(),\n        type: 'number_integer'\n      },\n      {\n        namespace: 'vividwalls',\n        key: 'large_available',\n        value: item.json.large_available.toString(),\n        type: 'number_integer'\n      },\n      {\n        namespace: 'vividwalls',\n        key: 'large_sold',\n        value: item.json.large_sold.toString(),\n        type: 'number_integer'\n      },\n      {\n        namespace: 'vividwalls',\n        key: 'last_sync',\n        value: new Date().toISOString(),\n        type: 'date_time'\n      }\n    ];\n    \n    items.push({\n      json: {\n        productId: productId.trim(),\n        handle: item.json.handle,\n        metafields: metafields\n      }\n    });\n  }\n}\n\nreturn items;"
      },
      "id": "prepare-metafields",
      "name": "Prepare Metafields",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "url": "=https://{{$credentials.shopifyDomain}}/admin/api/2024-01/products/{{$json.productId}}/metafields.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Shopify-Access-Token",
              "value": "={{$credentials.shopifyAccessToken}}"
            }
          ]
        },
        "method": "GET",
        "options": {
          "pagination": {
            "paginationMode": "responseContainsNextURL",
            "nextURL": "={{$response.headers[\"link\"].match(/<([^>]+)>; rel=\"next\"/)?.[1]}}"
          }
        }
      },
      "id": "get-existing-metafields",
      "name": "Get Existing Metafields",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1050, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "2",
          "name": "Shopify API"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Update or create metafields based on existing ones\nconst productId = $input.all()[0].json.productId;\nconst handle = $input.all()[0].json.handle;\nconst newMetafields = $input.all()[0].json.metafields;\nconst existingMetafields = $input.all()[0].json.metafields || [];\n\nconst updates = [];\nconst creates = [];\n\n// Process each new metafield\nfor (const newMeta of newMetafields) {\n  const existing = existingMetafields.find(m => \n    m.namespace === newMeta.namespace && m.key === newMeta.key\n  );\n  \n  if (existing) {\n    // Update existing metafield\n    updates.push({\n      id: existing.id,\n      value: newMeta.value,\n      type: newMeta.type\n    });\n  } else {\n    // Create new metafield\n    creates.push(newMeta);\n  }\n}\n\nreturn [{\n  json: {\n    productId: productId,\n    handle: handle,\n    updates: updates,\n    creates: creates,\n    hasUpdates: updates.length > 0,\n    hasCreates: creates.length > 0\n  }\n}];"
      },
      "id": "process-metafields",
      "name": "Process Metafields",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.hasUpdates}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-has-updates",
      "name": "Has Updates?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1450, 250]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.hasCreates}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-has-creates",
      "name": "Has Creates?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1450, 350]
    },
    {
      "parameters": {
        "url": "=https://{{$credentials.shopifyDomain}}/admin/api/2024-01/metafields/{{$json.id}}.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Shopify-Access-Token",
              "value": "={{$credentials.shopifyAccessToken}}"
            }
          ]
        },
        "method": "PUT",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metafield",
              "value": "={{$json}}"
            }
          ]
        }
      },
      "id": "update-metafield",
      "name": "Update Metafield",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1650, 200],
      "credentials": {
        "httpHeaderAuth": {
          "id": "2",
          "name": "Shopify API"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://{{$credentials.shopifyDomain}}/admin/api/2024-01/products/{{$json.productId}}/metafields.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Shopify-Access-Token",
              "value": "={{$credentials.shopifyAccessToken}}"
            }
          ]
        },
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "metafield",
              "value": "={{$json}}"
            }
          ]
        }
      },
      "id": "create-metafield",
      "name": "Create Metafield",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1650, 400],
      "credentials": {
        "httpHeaderAuth": {
          "id": "2",
          "name": "Shopify API"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "message",
              "value": "Inventory metafields synchronized"
            },
            {
              "name": "timestamp",
              "value": "={{new Date().toISOString()}}"
            }
          ]
        }
      },
      "id": "success-message",
      "name": "Success",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1850, 300]
    }
  ],
  "connections": {
    "cron-trigger": {
      "main": [
        [
          {
            "node": "postgres-get-inventory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "postgres-get-inventory": {
      "main": [
        [
          {
            "node": "batch-products",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "batch-products": {
      "main": [
        [
          {
            "node": "prepare-metafields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "prepare-metafields": {
      "main": [
        [
          {
            "node": "get-existing-metafields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get-existing-metafields": {
      "main": [
        [
          {
            "node": "process-metafields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process-metafields": {
      "main": [
        [
          {
            "node": "if-has-updates",
            "type": "main",
            "index": 0
          },
          {
            "node": "if-has-creates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if-has-updates": {
      "main": [
        [
          {
            "node": "update-metafield",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "success-message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "if-has-creates": {
      "main": [
        [
          {
            "node": "create-metafield",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "success-message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "update-metafield": {
      "main": [
        [
          {
            "node": "success-message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create-metafield": {
      "main": [
        [
          {
            "node": "success-message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateId": "vividwalls-inventory-metafield-sync"
  },
  "pinData": {},
  "versionId": "1.0.0",
  "triggerCount": 1
} 